name: Backend CI/CD - WorkNest

# Workflow sáº½ cháº¡y khi nÃ o?
on:
  push:
    branches: [ main, develop ]  # Khi push code lÃªn nhÃ¡nh main hoáº·c develop
    paths:
      - 'BEWorkNest/**'  # Chá»‰ cháº¡y khi cÃ³ thay Ä‘á»•i trong thÆ° má»¥c backend
  pull_request:
    branches: [ main, develop ]  # Khi táº¡o Pull Request vÃ o main hoáº·c develop
    paths:
      - 'BEWorkNest/**'
  workflow_dispatch:  # Cho phÃ©p cháº¡y thá»§ cÃ´ng tá»« GitHub UI

# Äá»‹nh nghÄ©a cÃ¡c job cáº§n cháº¡y
jobs:
  # Job 1: Build vÃ  Test Backend
  build-and-test:
    name: Build vÃ  Test Backend .NET
    runs-on: ubuntu-latest  # Cháº¡y trÃªn Ubuntu (miá»…n phÃ­)
    
    steps:
    # BÆ°á»›c 1: Láº¥y code vá»
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    # BÆ°á»›c 2: CÃ i Ä‘áº·t .NET SDK
    - name: ğŸ”§ Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'  # Version .NET cá»§a báº¡n
        
    # BÆ°á»›c 3: Cache dependencies Ä‘á»ƒ build nhanh hÆ¡n
    - name: ğŸ’¾ Cache NuGet packages
      uses: actions/cache@v3
      with:
        path: ~/.nuget/packages
        key: ${{ runner.os }}-nuget-${{ hashFiles('**/packages.lock.json') }}
        restore-keys: |
          ${{ runner.os }}-nuget-
    
    # BÆ°á»›c 4: Restore cÃ¡c package cáº§n thiáº¿t
    - name: ğŸ“¦ Restore dependencies
      working-directory: ./BEWorkNest
      run: dotnet restore BEWorkNest.sln
      
    # BÆ°á»›c 5: Build project
    - name: ğŸ”¨ Build
      working-directory: ./BEWorkNest
      run: dotnet build BEWorkNest.sln --no-restore --configuration Release
      
    # BÆ°á»›c 6: Cháº¡y Unit Tests (khi Ä‘Ã£ cÃ³ tests)
    - name: ğŸ§ª Run Unit Tests
      working-directory: ./BEWorkNest
      run: |
        dotnet test BEWorkNest.sln \
          --no-build \
          --configuration Release \
          --logger "trx;LogFileName=test-results.trx" \
          --logger "console;verbosity=detailed" \
          /p:CollectCoverage=true \
          /p:CoverletOutputFormat=cobertura \
          /p:CoverletOutput=./coverage/ \
          /p:Threshold=0
      continue-on-error: true  # Táº¡m thá»i cho phÃ©p fail khi chÆ°a cÃ³ tests
      
    # BÆ°á»›c 7: Generate Coverage Report
    - name: ğŸ“Š Generate Coverage Report
      if: always()  # LuÃ´n cháº¡y bÆ°á»›c nÃ y
      working-directory: ./BEWorkNest
      run: |
        dotnet tool install -g dotnet-reportgenerator-globaltool || true
        reportgenerator \
          "-reports:**/coverage.cobertura.xml" \
          "-targetdir:coverage-report" \
          "-reporttypes:Html;TextSummary" || echo "ChÆ°a cÃ³ coverage data"
      continue-on-error: true
      
    # BÆ°á»›c 8: Upload test results
    - name: ğŸ“¤ Upload Test Results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-results
        path: |
          BEWorkNest/**/test-results.trx
          BEWorkNest/coverage-report/
        retention-days: 30
      continue-on-error: true
      
    # BÆ°á»›c 9: Comment PR vá»›i káº¿t quáº£ coverage
    - name: ğŸ’¬ Comment Coverage on PR
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      continue-on-error: true
      with:
        script: |
          const fs = require('fs');
          let comment = '## ğŸ“Š Backend Test Results\n\n';
          comment += 'âœ… Build thÃ nh cÃ´ng!\n';
          comment += 'ğŸ§ª Unit tests Ä‘Ã£ cháº¡y\n';
          comment += 'ğŸ“ˆ Coverage report Ä‘Ã£ Ä‘Æ°á»£c táº¡o\n';
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });

  # Job 2: Code Quality Check
  code-quality:
    name: Kiá»ƒm tra cháº¥t lÆ°á»£ng code
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Cáº§n full history cho SonarCloud
        
    - name: ğŸ”§ Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'
        
    - name: ğŸ“¦ Restore dependencies
      working-directory: ./BEWorkNest
      run: dotnet restore BEWorkNest.sln
      
    - name: ğŸ”¨ Build
      working-directory: ./BEWorkNest
      run: dotnet build BEWorkNest.sln --no-restore
      
    # CÃ³ thá»ƒ thÃªm SonarCloud sau
    # - name: ğŸ” SonarCloud Scan
    #   uses: SonarSource/sonarcloud-github-action@master
    #   env:
    #     GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    #     SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
    
  # Job 3: Security Scan
  security-scan:
    name: Kiá»ƒm tra báº£o máº­t
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ”’ Run Dependency Check
      uses: dependency-check/Dependency-Check_Action@main
      with:
        project: 'WorkNest-Backend'
        path: './BEWorkNest'
        format: 'HTML'
      continue-on-error: true
      
    - name: ğŸ“¤ Upload Security Report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: security-report
        path: reports/
      continue-on-error: true
