name: Frontend CI/CD - WorkNest

# Workflow sáº½ cháº¡y khi nÃ o?
on:
  push:
    branches: [ main, develop ]
    paths:
      - 'feworknest/**'  # Chá»‰ cháº¡y khi cÃ³ thay Ä‘á»•i trong thÆ° má»¥c frontend
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'feworknest/**'
  workflow_dispatch:

jobs:
  # Job 1: Analyze vÃ  Test Flutter
  analyze-and-test:
    name: Analyze vÃ  Test Flutter
    runs-on: ubuntu-latest
    
    steps:
    # BÆ°á»›c 1: Láº¥y code vá»
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    # BÆ°á»›c 2: CÃ i Ä‘áº·t Flutter SDK
    - name: ğŸ”§ Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.19.0'  # Hoáº·c version má»›i nháº¥t
        channel: 'stable'
        cache: true  # Cache Flutter SDK
        
    # BÆ°á»›c 3: Kiá»ƒm tra Flutter version
    - name: â„¹ï¸ Flutter version
      run: flutter --version
      
    # BÆ°á»›c 4: CÃ i Ä‘áº·t dependencies
    - name: ğŸ“¦ Install dependencies
      working-directory: ./feworknest
      run: flutter pub get
      
    # BÆ°á»›c 5: Verify dependencies
    - name: ğŸ” Verify dependencies
      working-directory: ./feworknest
      run: flutter pub outdated || true
      
    # BÆ°á»›c 6: Format check
    - name: ğŸ“ Check formatting
      working-directory: ./feworknest
      run: dart format --set-exit-if-changed . || true
      continue-on-error: true
      
    # BÆ°á»›c 7: Analyze code
    - name: ğŸ” Analyze code
      working-directory: ./feworknest
      run: flutter analyze --no-fatal-infos
      continue-on-error: true
      
    # BÆ°á»›c 8: Run tests vá»›i coverage
    - name: ğŸ§ª Run tests with coverage
      working-directory: ./feworknest
      run: flutter test --coverage --reporter expanded
      continue-on-error: true
      
    # BÆ°á»›c 9: Upload coverage
    - name: ğŸ“Š Upload coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        files: ./feworknest/coverage/lcov.info
        flags: frontend
        name: flutter-coverage
      continue-on-error: true
      
    # BÆ°á»›c 10: Generate coverage report HTML
    - name: ğŸ“Š Generate coverage HTML
      working-directory: ./feworknest
      run: |
        sudo apt-get update
        sudo apt-get install -y lcov
        genhtml coverage/lcov.info -o coverage/html || echo "ChÆ°a cÃ³ coverage data"
      continue-on-error: true
      
    # BÆ°á»›c 11: Upload test results
    - name: ğŸ“¤ Upload Test Results
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: flutter-test-results
        path: |
          feworknest/coverage/
        retention-days: 30
      continue-on-error: true
      
    # BÆ°á»›c 12: Comment PR vá»›i káº¿t quáº£
    - name: ğŸ’¬ Comment Test Results on PR
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      continue-on-error: true
      with:
        script: |
          let comment = '## ğŸ“± Frontend Test Results\n\n';
          comment += 'âœ… Flutter analyze hoÃ n thÃ nh!\n';
          comment += 'ğŸ§ª Tests Ä‘Ã£ cháº¡y\n';
          comment += 'ğŸ“Š Coverage report Ä‘Ã£ Ä‘Æ°á»£c táº¡o\n';
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });

  # Job 2: Build Android APK (optional)
  build-android:
    name: Build Android APK
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ”§ Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.19.0'
        channel: 'stable'
        cache: true
        
    - name: ğŸ”§ Setup Java
      uses: actions/setup-java@v3
      with:
        distribution: 'zulu'
        java-version: '17'
        
    - name: ğŸ“¦ Install dependencies
      working-directory: ./feworknest
      run: flutter pub get
      
    - name: ğŸ”¨ Build APK
      working-directory: ./feworknest
      run: flutter build apk --release
      
    - name: ğŸ“¤ Upload APK
      uses: actions/upload-artifact@v3
      with:
        name: android-apk
        path: feworknest/build/app/outputs/flutter-apk/app-release.apk
        retention-days: 30

  # Job 3: Build Web (optional)
  build-web:
    name: Build Web
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ”§ Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.19.0'
        channel: 'stable'
        cache: true
        
    - name: ğŸ“¦ Install dependencies
      working-directory: ./feworknest
      run: flutter pub get
      
    - name: ğŸ”¨ Build Web
      working-directory: ./feworknest
      run: flutter build web --release
      
    - name: ğŸ“¤ Upload Web Build
      uses: actions/upload-artifact@v3
      with:
        name: web-build
        path: feworknest/build/web/
        retention-days: 30
